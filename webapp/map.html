<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <script src="/webapp/assets/js/xml2json.js"></script>
    <script src="/webapp/assets/js/coordinatesCalc.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>

    <!-- https://github.com/CliffCloud/Leaflet.EasyButton -->
    <link rel="stylesheet" href="/webapp/assets/css/easy-button.css" />
    <script src="/webapp/assets/js/easy-button.js"></script>
    <!-- https://cdnjs.com/libraries/font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        #map {
            width: auto;
            height: 500px;
            position: absolute;
            text-align: center;
            left: 5%;
            right: 5%;
            bottom: 5%;
            border-style: solid;
            border-width: 2px;
            /* border-radius: 50%; */
            border-color: black;
        }
        .false-anchor {
            cursor: pointer;
            text-decoration: underline;
            color:rgb(0, 0, 238);
        }
        .icon-selected {
            color:rgb(0, 132, 255);
        }
    </style>
</head>

<body>
    <input id="image-file" type="file" accept="image/*"/>
    <div>Station: (<a class="false-anchor" id="jumpToStation">KLWX</a>)</div>
    <input id="stationInput">
    <br>
    <button id="theSubmitter">Ok</button>
    <div id="statLat"></div>
    <div id="statLon"></div>
    <script>
        document.getElementById('jumpToStation').addEventListener("click", function() {
            document.getElementById('stationInput').value = "KLWX";
            $('#theSubmitter').trigger('click');
        });
    </script>

    <div id="weathermap"><b>Please input a radar station.</b></div>

    <script>
        // 38.9761
		// -77.4875
        document.getElementById('theSubmitter').addEventListener("click", function() {
            $.getJSON('https://steepatticstairs.github.io/weather/json/radarStations.json', function(data) {
                var formattedStation = document.getElementById('stationInput').value;
                formattedStation = formattedStation.toUpperCase().replace(/ /g, '');

                var stationLat = data[formattedStation][1];
                document.getElementById('statLat').innerHTML = stationLat;
                var stationLon = data[formattedStation][2];
                document.getElementById('statLon').innerHTML = stationLon;

                document.getElementById('weathermap').innerHTML = "<div id='map'></div>";

                var map = 
                L.map('map', {
                    renderer: L.svg(),
                    //attributionControl: false, // Disable the autogenerated attribution 
                    zoomControl: true,
                    //touchZoom: false,
                    zoomDelta: 0.5,
                    zoomSnap: 0.5,
                }).setView([stationLat, stationLon], 7);

                var osmLayer = 
                L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                var allLayerGroup = L.layerGroup();
                var imageLayerGroup = L.layerGroup().addTo(map);

                map.on('zoomstart', function() {
                    allLayerGroup.clearLayers();
                    map.eachLayer(function (layer) {
                        if (layer != osmLayer) {
                            map.removeLayer(layer);
                            allLayerGroup.addLayer(layer);
                        }
                    });
                });
                map.on('zoomend', function() {
                    allLayerGroup.eachLayer(function (layer) {
                        map.addLayer(layer);
                    });
                });

                var imageButton = 
                L.easyButton({
                    states: [{
                        icon: '<span class="fa fa-image" id="faImageSpan" style="line-height:28px"></span>',
                        stateName: 'add',
                        onClick: function(control) {
                            showImage(stationLat, stationLon, URL.createObjectURL(document.getElementById("image-file").files[0]))
                            control.state('remove');
                        }
                    }, {
                        icon: '<span class="fa fa-image icon-selected" id="faImageSpan" style="line-height:28px"></span>',
                        stateName: 'remove',
                        onClick: function(control) {
                            imageLayerGroup.clearLayers();
                            control.state('add');
                        },
                    }],
                        //tagName: 'a'
                }).addTo(map);

                function showImage(centerLat, centerLon, imagePath) {
                    // 315, 135
                    //var lightningLayer = 
                    //L.tileLayer('https://tiles.lightningmaps.org/?x={x}&y={y}&z={z}&s=256', {
                    //}).addTo(lightningLayerGroup);
                    //setImageFromCenter(950, '/weather/nexrad/radar.png');

                    var distance = "460";

                    var NWcoords = Point_At_Distance_And_Bearing(centerLat, centerLon, distance, "315");
                    var SEcoords = Point_At_Distance_And_Bearing(centerLat, centerLon, distance, "135");

                    var NWlat = NWcoords[0];
                    // var NWlon = NWcoords[1] + .3;
                    var NWlon = NWcoords[1];
                    var SElat = SEcoords[0];
                    var SElon = SEcoords[1];

                    var sussyballs = [[NWlat, NWlon], [SElat, SElon]]
                    L.imageOverlay(imagePath, sussyballs).addTo(imageLayerGroup);
                }
            })
        }); 
    </script>
</body>
</html>